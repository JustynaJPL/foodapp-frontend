<div class="back">
  <button mat-raised-button color="accent" (click)="goBack()">
    <span class="material-symbols-outlined"> arrow_back </span>
    <label for="">Powrót</label>
  </button>
</div>

<form [formGroup]="recipeForm" class="new-recipe" (ngSubmit)="submitForm()">
  <ng-container>
    <div class="image-cont">
      <input
        type="file"
        (change)="handleFileInput($event)"
        accept="image"
        name="image"
      />
      <mat-error *ngIf="hasError('image', 'required')">
        Zdjęcie jest wymagane
      </mat-error>
      <img
        [src]="imageUrl ? imageUrl : '../assets/placeholder.jpg'"
        alt="Wybrane zdjęcie"
        class="image"
      />
    </div>
  </ng-container>

  <div class="recipe-content">
    <h1>Dodaj nowy przepis</h1>
    <ng-container>
      <mat-form-field>
        <mat-label>Nazwa przepisu</mat-label>
        <input
          matInput
          placeholder="Np. Owsianka z malinami"
          formControlName="nazwaPrzepisu"
        />
        <mat-error *ngIf="hasError('nazwaPrzepisu', 'required')">
          Nazwa przepisu jest wymagana
        </mat-error>
      </mat-form-field>
    </ng-container>

    <div class="divider-text">
      <h1>Kategoria przepisu</h1>
      <div formGroupName="kategoria">
        <mat-form-field>
          <mat-label>Wybierz kategorię</mat-label>
          <!-- Teraz możemy bezpośrednio odwołać się do kontrolki 'nazwa' -->
          <mat-select
            formControlName="nazwa"
            (selectionChange)="onKategoriaChange($event)"
          >
            <mat-option
              *ngFor="let kat of kategorie; let i = index"
              [value]="kat.nazwa"
            >
              {{ kat.nazwa }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <!-- Aby sprawdzić błąd, musisz zmienić sposób dostępu do błędu -->
        <mat-error
          *ngIf="
            recipeForm.get('kategoria')?.get('nazwa')?.hasError('required')
          "
        >
          Kategoria przepisu musi być wybrana
        </mat-error>
      </div>
    </div>

    <div formArrayName="skladniki">
      <h1>Składniki przepisu</h1>
      <ng-container
        *ngFor="let skladnik of skladniki.controls; let i = index"
        [formGroupName]="i"
      >
        <mat-form-field>
          <mat-label>Wybierz produkt</mat-label>
          <mat-select
            (selectionChange)="onProduktChange($event, i)"
            formControlName="nazwa"
          >
            <mat-option
              *ngFor="let prod of produkty; let j = index"
              [value]="prod.nazwaProduktu"
            >
              {{ prod.nazwaProduktu }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field>
          <mat-label>Ilość[g]</mat-label>
          <input
            matInput
            type="number"
            placeholder="100"
            formControlName="ilosc"
            required
            min="0"
            (blur)="makecalculations(i)"
            (keydown)="onInputKeyDown($event)"
          />
          <mat-error
            *ngIf="skladniki.controls[i]?.get('iloscskladnika')?.errors?.['required']"
          >
            Ilość składnika musi być określona
          </mat-error>
        </mat-form-field>
        <ng-container>
          <mat-form-field class="per100">
            <mat-label>Kcal</mat-label>
            <input matInput disabled [value]="skladnik.get('kcal')?.value" />
          </mat-form-field>
          <mat-form-field class="per100">
            <mat-label>Tłuszcze</mat-label>
            <input
              matInput
              disabled
              [value]="skladnik.get('tluszcze')?.value"
            />
          </mat-form-field>
          <mat-form-field class="per100">
            <mat-label>Węglowodany</mat-label>
            <input
              matInput
              disabled
              [value]="skladnik.get('weglowodany')?.value"
            />
          </mat-form-field>
          <mat-form-field class="per100">
            <mat-label>Białko</mat-label>
            <input matInput disabled [value]="skladnik.get('bialko')?.value" />
          </mat-form-field>
        </ng-container>
        <ng-container class="perportion">
          <mat-form-field class="perp">
            <mat-label> Kcal w porcji</mat-label>
            <input
              matInput
              disabled
              [value]="skladnik.get('kcalperw')?.value"
            />
          </mat-form-field>
          <mat-form-field class="perp">
            <mat-label> Tłuszcze w porcji </mat-label>
            <input
              matInput
              disabled
              [value]="skladnik.get('tluszczeperw')?.value"
            />
          </mat-form-field>
          <mat-form-field class="perp">
            <mat-label> Węglowodany w porcji </mat-label>
            <input
              matInput
              disabled
              [value]="skladnik.get('weglowodanyperw')?.value"
            />
          </mat-form-field>
          <mat-form-field class="perp">
            <mat-label> Białko w porcji </mat-label>
            <input
              matInput
              disabled
              [value]="skladnik.get('bialkoperw')?.value"
            />
          </mat-form-field>
        </ng-container>
        <button mat-raised-button color="primary" (click)="deleteSkladnik(i)">
          <span class="material-symbols-outlined">delete</span>
        </button>
      </ng-container>

      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="addSkladnik()"
        class="perp"
      >
        +
      </button>
    </div>

    <div class="summary">
      <ng-container>
        <mat-form-field class="fin8">
          <mat-label> Kcal całkowite</mat-label>
          <input matInput disabled [value]="recipeForm.get('kcal')?.value" />
        </mat-form-field>
        <mat-form-field class="fin8">
          <mat-label> Tłuszcze całkowite </mat-label>
          <input
            matInput
            disabled
            [value]="recipeForm.get('tluszcze')?.value"
          />
        </mat-form-field>
        <mat-form-field class="fin8">
          <mat-label> Węglowodany całkowite </mat-label>
          <input
            matInput
            disabled
            [value]="recipeForm.get('weglowodany')?.value"
          />
        </mat-form-field>
        <mat-form-field class="fin8">
          <mat-label> Białko całkowite </mat-label>
          <input matInput disabled [value]="recipeForm.get('bialko')?.value" />
        </mat-form-field>
      </ng-container>
    </div>

    <div class="divider-text" formArrayName="instrukcje">
      <h1>Czynności:</h1>
      <ng-container
        *ngFor="let instrukcja of instrukcje.controls; let i = index"
      >
        <mat-form-field>
          <mat-label>{{ i + 1 }}.</mat-label>
          <textarea
            matInput
            cdkTextareaAutosize
            #autosize="cdkTextareaAutosize"
            cdkAutosizeMinRows="1"
            cdkAutosizeMaxRows="5"
            [formControlName]="i"
            (input)="checkFields(i)"
          ></textarea>
          <mat-error *ngIf="instrukcje.controls[i].hasError('required')">
            Przynajmniej jedna instrukcja musi zostać dodana
          </mat-error>
        </mat-form-field>
      </ng-container>
    </div>
  </div>
  <button type="submit">Dodaj przepis</button>
</form>
